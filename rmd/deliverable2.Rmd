---
title: "Deliverable 2"
author: "Garrett Hawes"
date: "`r Sys.Date()`"
output: 
  html_document: 
    fig_caption: yes
    highlight: tango
    includes:
      before_body: includes/header.html
    number_sections: yes
    self_contained: no
    theme: cerulean
    toc: yes
    toc_float:
      collapsed: no
      smooth_scroll: no
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("conflicted")
library("here")
load(here::here("data","output","clean_wine.RData"))
library("arsenal")
library("tidyverse")
library("knitr")
library("kableExtra")
library("ggExtra")
library("ggthemes")
library("GGally")
library("ggmap")
library("plyr")
library("stringr")
library("stringi")
library("PerformanceAnalytics")
library('sentimentr')
library("tm")
library("SnowballC")
library("RColorBrewer")
conflict_prefer("mutate", "dplyr")
conflict_prefer("summarize", "dplyr")
```

# Load Data 

```{r}
wine_data <-
  read.csv(here::here("data", "input", "winemag-data-130k-v2.csv"))
colors <- read.csv(here::here("data", "input", "wine-colors.csv"))
twitter_stats <- read.csv(here::here("data", "input", "twitter-data.csv"))

# Add color
# wine_data_with_color <- left_join(wine_data, colors, by = "variety")
wine_data <- dplyr::left_join(wine_data, colors, by = "variety")

# Add in twitter stats 

wine_data <- dplyr::left_join(wine_data, twitter_stats, by = "taster_twitter_handle")

```



# Clean

## Functions
```{r}
.clean_text <- function(x) {
  x <- stringi::stri_trans_general(x, "Latin-ASCII")
  x <- str_replace_all(x, "[^A-Za-z]", " ")
  x <- tolower(x)
  x <- str_squish(x)
  return(x)
}

.clean_fct_text <- function(x) {
  x <- as.character(x)
  .clean_text(x)
  return(x)
}
```

## Color Revalue

```{r}
wine_data <-
  wine_data %>% dplyr::mutate(color = revalue(
    wine_data$color,
    c(
      "O" = "Other",
      "R" = "Red",
      "W" = "White",
      "SW" = "Sparkling White"
    )
  ))
```

## Apply Cleaning
Apply the cleaning strategies from above
```{r}
wine_data <-
  wine_data %>% dplyr::mutate(
    country = as.character(country),
    variety = as.character(variety),
    taster_name = as.character(taster_name),
    title = as.character(title),
    color_lump = fct_lump(color, n = 2), 
    province_lump = fct_lump(wine_data$province, n = 10),
    country_lump = fct_lump(wine_data$country, n = 10)
  ) %>%
  dplyr::filter (country != "" &
            variety != "" & taster_name != "") %>% drop_na(price) 
```

# Feature Generation

## Points Categories
 Turn score into categories per https://www.winespectator.com/articles/scoring-scale
```{r}
wine_data <-
  wine_data  %>% dplyr::mutate(point_cat = cut(
    wine_data$points,
    breaks = c(0, 74, 79, 84, 89, 94, 100),
    labels = c(
      "Not Recomended",
      "Mediocre",
      "Good",
      "Very good",
      "Outstanding",
      "Classic"
    )
  ))
```

## Title Features {.tabset .tabset-fade .tabset-pills}

### Legth

```{r}
wine_data <-
  wine_data %>% dplyr::mutate(title_length = nchar(as.character(wine_data$title)))
```

### Has Accent(s)
Has accents presuming the american market might pay more ... or less for wines that sound exotic.
```{r}
wine_data <-
  wine_data %>% dplyr::mutate(title_has_accents = (title != stringi::stri_trans_general(title, "Latin-ASCII")))
```

### Title Sentiment Analysis and Word Count

```{r}
 wine_data <- 
   wine_data %>% dplyr::mutate(title_no_accents = stringi::stri_trans_general(title, "Latin-ASCII"))
# 
s <- sentiment_by(wine_data$title_no_accents)

qplot(s$ave_sentiment, geom="histogram",binwidth=0.2,main="Wine Title Sentiment Histogram")

wine_data <- wine_data %>% dplyr::mutate( title_sentement = s$ave_sentiment, title_word_count = s$word_count)
```

## Designation column {.tabset .tabset-fade .tabset-pills}

### Clean text

```{r}
wine_data <- wine_data %>% dplyr::mutate(designation = .clean_text(designation))
wine_designations_word_cloud <- wine_data

```
 
### Identify Possible Groups

```{r}
wine_designations_word_cloud <-
  wine_designations_word_cloud %>% mutate(designation = str_replace_all(designation, "([Rr].serv.)", "Reserve"))

## Calculate Corpus

wineDesignation.Corpus <-
Corpus(VectorSource(wine_designations_word_cloud$designation))

#Data Cleaning and Wrangling

wineDesignation.clean <- tm_map(wineDesignation.Corpus,
                                 PlainTextDocument)
wineDesignation.clean <-
  tm_map(wineDesignation.Corpus, tolower)
wineDesignation.clean <-
  tm_map(wineDesignation.Corpus, removeNumbers)
wineDesignation.clean <-
  tm_map(wineDesignation.Corpus, removeWords, stopwords("english"))
wineDesignation.clean <-
  tm_map(wineDesignation.Corpus, removePunctuation)
wineDesignation.clean <-
  tm_map(wineDesignation.Corpus, stripWhitespace)

```


### Group
```{r}
# List of regular expressions to match

patterns <-
  c(
    ".*([Rr].serv).*",
    ".*extra dry.*",
    ".*(dry|trocken).*",
    ".*brut.*",
    ".*(estate|grand|casa).*",
    ".*single.*",
    ".*(klassik|classic|tradition|vintage).*",
    ".*rose.*",
    ".*barrel s.*",
    ".*(old v|vieilles).*",
    ".*(vineyard|ranch|alpha|branco|broquel).*",
    ".*(barrel|crianza|cuve).*",
    ".*unoaked.*",
    ".*cuve prestige.*",
    ".*(blanc|white|bianco).*",
    ".*(red|tinto|bussia).*",
    ".*(nouveau|proprietary|signature|selec|premier).*",
    ".*lot.*",
    ".*late.*",
    ".*(oak|roble).*",
    ".*(organic|cannubi).*",
    ".*(port|colheita).*",
    ".*(collection|premium|prestige|limited).*",
    ".*clone.*",
    ".*(block|bin).*",
    "^$"
  )

# Values to replace above patterns with

replacements <-
  c(
    "Reserve",
    "Extra Dry",
    "Dry",
    "Brut",
    "Estate",
    "Single Vineyard",
    "Classic Vintage",
    "Rose",
    "Barrel Sample",
    "Old Vine",
    "Some Vineyard",
    "Barrel",
    "UnOaked",
    "Finest Champagne",
    "White",
    "Red",
    "Signature",
    "Lot",
    "Late Harvest",
    "Oak",
    "Organic",
    "Port",
    "Premium",
    "Clone",
    "Block",
    "No Designation"
  )

# This is so that we can use the replacements object in str_replace_all rather than a single pattern/replacement

names(replacements) <- patterns

wine_data <-
  wine_data %>% dplyr::mutate(designation = str_replace_all(designation, replacements)) %>% # replace per above
  dplyr::mutate(designation = as.factor(designation))
```

## Lump Varieties
```{r}
.append_color_to_factor <- function(variety, color) {
  variety = as.character(variety)
  variety = paste(variety, color)
  return(variety)
}

red <-
  wine_data %>% dplyr::filter(color_lump == "Red") %>%
  dplyr::mutate(variety_lump = fct_lump(variety, n = 5)) %>%
  dplyr::mutate(variety_lump = .append_color_to_factor(variety_lump, "(R)"))
white <-
  wine_data %>% dplyr::filter(color_lump == "White") %>%
  dplyr::mutate(variety_lump = fct_lump(variety, n = 5)) %>%
  dplyr::mutate(variety_lump = .append_color_to_factor(variety_lump, "(W)"))
other <-
  wine_data %>% dplyr::filter(color_lump == "Other") %>%
  dplyr::mutate(variety_lump = "Other")

wine_data_bind <- do.call("rbind", list(red, white, other))

wine_data <-
  wine_data_bind %>% dplyr::mutate(variety_lump = factor(variety_lump))
```

## Lump Other Factors
```{r}
wine_data <-
  wine_data %>% dplyr::filter(as.character(taster_twitter_handle) != "") %>% dplyr::mutate(
    taster_name_lump = fct_lump(taster_name, n = 5),
    taster_twitter_lump = fct_lump(taster_twitter_handle, n = 5),
    designation_lump = fct_lump(designation, n = 10),
    country_lump = fct_lump(country, n = 10),
    variety_lump = fct_lump(variety, n = 10)
  )
```

## Add reviewer stats
```{r}
wine_data <- wine_data %>%
  dplyr::group_by(taster_name) %>%
  dplyr::mutate(taster_avg_points = mean(points),
                   taster_review_count = n()) %>% dplyr::ungroup()
```

## Ad ID column
```{r}
wine_data <- tibble::rowid_to_column(wine_data, "ID")
```

## Drop unused point category factors 
```{r}
setdiff(levels(wine_data$point_cat), wine_data$point_cat)
fct_drop(wine_data$point_cat)
```

## Drop unneeded columns 
```{r}
wine_data_clean <-
  wine_data %>%
  dplyr::select(
    ID,
    price,
    country,
    variety,
    points,
    point_cat,
    title_length,
    title_has_accents,
    variety_lump,
    designation_lump,
    taster_name_lump,
    taster_twitter_lump,
    taster_gender,
    taster_avg_points,
    taster_review_count,
    taster_n_tweets,
    color_lump,
    country_lump,
    province_lump,
    #title_word_count,
    #title_sentement
  ) %>% droplevels()
```

## Unused columns
```{r}
setdiff(names(wine_data), names(wine_data_clean))
```

# Summary Statistics 
Need to figure out a way to get this to look good on pdf or use html

c("ID", "price", "country", "variety", "points", "point_cat", 
"title_length", "title_has_accents", "variety_lump", "designation_lump", 
"taster_name_lump", "taster_twitter_lump", "taster_gender", "taster_avg_points", 
"taster_review_count", "taster_n_tweets", "color_lump", "country_lump", 
"province_lump")

```{r summary, results="asis"}
#table_one <- tableby(point_cat ~ ., data = wine_data_clean %>% select(c("price", "points", "point_cat", "title_length", "taster_review_count", "taster_n_tweets", "country_lump")))
table_one <-
  tableby(cut(price, breaks = c(0,5,10,25,150,3000)) ~ ., data = wine_data_clean %>% select(
    c(
      "price",
      "variety_lump",
      "points",
      "point_cat",
      "title_length",
      "title_has_accents",
      "variety_lump",
      "designation_lump",
      "taster_twitter_lump",
      "taster_gender",
      "taster_avg_points",
      "taster_review_count",
      "taster_n_tweets",
      "country_lump",
      "province_lump",
      "color_lump"
    )
  ))
summary(table_one, title = "Wine Data by Country")

```




# Plots 

## Maps
```{r map, message=FALSE}
world_map <- map_data("world")
world_map <-
  world_map %>% dplyr::mutate(region = ifelse(region == "USA", "US", region))
world_map <- world_map %>% dplyr::mutate(country = region)

wine_map_DF <-
  wine_data_clean  %>% dplyr::mutate(country = as.character(country)) %>%
  dplyr::filter (country != "England" &
            country != "US-France" &
            country != "")

# Generate Summary
wmap <-
  wine_data_clean %>%
  dplyr::group_by(country) %>%
  dplyr::summarize(
    point_min = min(points, na.rm = TRUE),
    point_avg = mean(points, na.rm = TRUE),
    point_max = max(points, na.rm = TRUE),
    price_min = min(price, na.rm = TRUE),
    price_avg = mean(price, na.rm = TRUE),
    price_max = max(price, na.rm = TRUE)
  ) %>%
  dplyr::select(
    c(
      "country",
      "point_min",
      "point_avg",
      "point_max",
      "price_min",
      "price_avg",
      "price_max"
    )
  )
# Create data frame with bounderies and values
wine_country_map <- right_join(wmap, world_map, by = "country")

.map_from_attribute <- function(att, title) {
  return(
    ggplot(wine_country_map, aes_string(map_id = "country", fill = att)) +
      geom_map(map = wine_country_map,  color = "white") +
      expand_limits(x = wine_country_map$long, y = wine_country_map$lat) +
      scale_fill_viridis_c(option = "C") + theme_map() + ggtitle(title)
  )
}
.map_from_attribute("point_min", "Points Min by Country")
```


## Corelation
```{r plot1, fig.height=9, fig.width=10, message=FALSE}
ggpairs(wine_data_clean, columns = c(2,5,7, 14, 16), ggplot2::aes(colour=color_lump))
```

# Scatter with marginal desnsity histogram
```{r plot2, message=FALSE}
p <- ggplot(wine_data_clean, aes(points, price, color = point_cat)) + geom_point() + theme_clean() + labs(title = "Price vs Points")  #+ facet_wrap(~ color_lump + taster_gender)
p1 <- ggMarginal(p, type="histogram", fill="slateblue") 
p1 
```

# Box Plot
```{r plot3, fig.height=8, fig.width=10, message=FALSE}
wine_data_clean %>% ggplot(aes(x = reorder(color_lump, points), y = points, fill = color_lump)) + geom_boxplot() + 
  xlab("Color") + theme_clean() + theme(legend.position = "none") + ggtitle("Wine Score vs color. Faceted by Gender and presence of accents in title") + facet_wrap(~ country_lump)
```

## Score Vs log(price) faceted by Gender
```{r plot4, message=FALSE}
ggplot(wine_data_clean, aes(log(price), points, color = point_cat)) + geom_point() + theme_fivethirtyeight() + labs(title = "Score vs log of Price") + facet_wrap(~ taster_gender)

```

## log(price) vs log(points) faceted by Country
```{r plot5, message=FALSE}
ggplot(wine_data_clean, aes(log(price), log(points), color = point_cat)) + geom_point() + theme_fivethirtyeight() + labs(title = "Score vs log of Price") + facet_wrap(~ country_lump)

```

Price and Country colored by rating category
```{r plot6, fig.height=6, fig.width=8, message=FALSE, warning=FALSE, paged.print=TRUE}
ggplot(wine_data_clean, aes(x = price, y = country_lump, color = point_cat)) +
  geom_jitter(alpha=1/2) + ggtitle("Price and Country Colored by Point_Cat")

```

log(Price) and Country colored by rating category
#Same as above but with log(price)
```{r plot7, fig.height=8, fig.width=8, message=FALSE, warning=FALSE, paged.print=TRUE}
ggplot(wine_data_clean, aes(x = log(price), y = country_lump, color = point_cat)) +
  geom_jitter(alpha=1/2) + ggtitle("log(Price) and Country Colored by Point_Cat")
```

#Same as above but with log(price)
```{r plot8, fig.height=5, fig.width=8, message=FALSE, warning=FALSE, paged.print=TRUE}
  ggplot(wine_data_clean, aes(x = log(price), y = taster_n_tweets, color = point_cat)) +
  geom_jitter(alpha=1/2) + ggtitle("log(Price) and Country Colored by Point_Cat")
```



